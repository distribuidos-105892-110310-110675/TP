name: tp
services:

  # ============================== RABBITMQ SERVICE ============================== #

  rabbitmq-message-middleware:
    image: "rabbitmq:4-management"
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_USER}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASS}
    networks:
      - custom_net
    healthcheck:
      test: rabbitmq-diagnostics check_port_connectivity
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 30s

  # ============================== CLIENT & SERVER SERVICES ============================== #

  client:
    container_name: client
    image: client:latest
    entrypoint: python3 -m client.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CLIENT_ID=0
      - SERVER_HOST=server
      - SERVER_PORT=5000
      - DATA_PATH=/data
      - RESULTS_PATH=/results
      - BATCH_MAX_SIZE=${BATCH_MAX_SIZE}
    networks:
      - custom_net
    volumes:
      - type: bind
        source: ${LOCAL_DATA_PATH}
        target: /data
        read_only: true
      - type: bind
        source: ${LOCAL_RESULTS_PATH}
        target: /results
        read_only: false
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 1
    depends_on:
      server:
        condition: service_started

  server:
    container_name: server
    image: server:latest
    entrypoint: python3 -m server.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - SERVER_PORT=5000
      - SERVER_LISTEN_BACKLOG=${SERVER_LISTEN_BACKLOG}
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - MENU_ITEMS_CLN_AMOUNT=1
      - STORES_CLN_AMOUNT=1
      - TRANSACTION_ITEMS_CLN_AMOUNT=4
      - TRANSACTIONS_CLN_AMOUNT=4
      - USERS_CLN_AMOUNT=1
      - Q1X_OB_AMOUNT=1
      - Q21_OB_AMOUNT=1
      - Q22_OB_AMOUNT=1
      - Q3X_OB_AMOUNT=1
      - Q4X_OB_AMOUNT=1
    networks:
      - custom_net
    deploy:
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 1
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy
      join_item_count_with_menu_0:
        condition: service_started
      join_item_sum_with_menu_0:
        condition: service_started
      join_transactions_with_stores_0:
        condition: service_started

  # ============================== CLEANERS SERVICES ============================== #

  menu_items_cleaner_items_0:
    container_name: menu_items_cleaner_items_0
    image: menu_items_cleaner:latest
    entrypoint: python3 -m controllers.cleaners.menu_items_cleaner.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CONTROLLER_ID=0
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - NEXT_CONTROLLERS_AMOUNT=1
    networks:
      - custom_net
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy

  stores_cleaner_items_0:
    container_name: stores_cleaner_items_0
    image: stores_cleaner:latest
    entrypoint: python3 -m controllers.cleaners.stores_cleaner.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CONTROLLER_ID=0
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - NEXT_CONTROLLERS_AMOUNT=2
    networks:
      - custom_net
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy

  transaction_items_cleaner_0:
    container_name: transaction_items_cleaner_0
    image: transaction_items_cleaner:latest
    entrypoint: python3 -m controllers.cleaners.transaction_items_cleaner.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CONTROLLER_ID=0
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - NEXT_CONTROLLERS_AMOUNT=3
    networks:
      - custom_net
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy
  
  transaction_items_cleaner_1:
    container_name: transaction_items_cleaner_1
    image: transaction_items_cleaner:latest
    entrypoint: python3 -m controllers.cleaners.transaction_items_cleaner.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CONTROLLER_ID=1
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - NEXT_CONTROLLERS_AMOUNT=3
    networks:
      - custom_net
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy

  transaction_items_cleaner_2:
    container_name: transaction_items_cleaner_2
    image: transaction_items_cleaner:latest
    entrypoint: python3 -m controllers.cleaners.transaction_items_cleaner.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CONTROLLER_ID=2
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - NEXT_CONTROLLERS_AMOUNT=3
    networks:
      - custom_net
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy

  transaction_items_cleaner_3:
    container_name: transaction_items_cleaner_3
    image: transaction_items_cleaner:latest
    entrypoint: python3 -m controllers.cleaners.transaction_items_cleaner.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CONTROLLER_ID=3
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - NEXT_CONTROLLERS_AMOUNT=3
    networks:
      - custom_net
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy

  transactions_cleaner_0:
    container_name: transactions_cleaner_0
    image: transactions_cleaner:latest
    entrypoint: python3 -m controllers.cleaners.transactions_cleaner.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CONTROLLER_ID=0
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - NEXT_CONTROLLERS_AMOUNT=3
    networks:
      - custom_net
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy

  transactions_cleaner_1:
    container_name: transactions_cleaner_1
    image: transactions_cleaner:latest
    entrypoint: python3 -m controllers.cleaners.transactions_cleaner.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CONTROLLER_ID=1
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - NEXT_CONTROLLERS_AMOUNT=3
    networks:
      - custom_net
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy

  transactions_cleaner_2:
    container_name: transactions_cleaner_2
    image: transactions_cleaner:latest
    entrypoint: python3 -m controllers.cleaners.transactions_cleaner.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CONTROLLER_ID=2
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - NEXT_CONTROLLERS_AMOUNT=3
    networks:
      - custom_net
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy

  transactions_cleaner_3:
    container_name: transactions_cleaner_3
    image: transactions_cleaner:latest
    entrypoint: python3 -m controllers.cleaners.transactions_cleaner.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CONTROLLER_ID=3
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - NEXT_CONTROLLERS_AMOUNT=3
    networks:
      - custom_net
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy

  users_cleaner_0:
    container_name: users_cleaner_0
    image: users_cleaner:latest
    entrypoint: python3 -m controllers.cleaners.users_cleaner.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CONTROLLER_ID=0
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - NEXT_CONTROLLERS_AMOUNT=2
    networks:
      - custom_net
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy

  # ============================== FILTER TRANSACTIONS SERVICES ============================== #

  filter_transactions_by_year_0:
    container_name: filter_transactions_by_year_0
    image: filter_transactions_by_year:latest
    entrypoint: python3 -m controllers.filters.filter_transactions_by_year.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CONTROLLER_ID=0
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - PREV_CONTROLLERS_AMOUNT=4
      - FILTERS_AMOUNT=2
      - YEARS=2024,2025
    networks:
      - custom_net
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy

  filter_transactions_by_year_1:
    container_name: filter_transactions_by_year_1
    image: filter_transactions_by_year:latest
    entrypoint: python3 -m controllers.filters.filter_transactions_by_year.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CONTROLLER_ID=1
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - PREV_CONTROLLERS_AMOUNT=4
      - FILTERS_AMOUNT=2
      - YEARS=2024,2025
    networks:
      - custom_net
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy

  filter_transactions_by_year_2:
    container_name: filter_transactions_by_year_2
    image: filter_transactions_by_year:latest
    entrypoint: python3 -m controllers.filters.filter_transactions_by_year.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CONTROLLER_ID=2
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - PREV_CONTROLLERS_AMOUNT=4
      - FILTERS_AMOUNT=2
      - YEARS=2024,2025
    networks:
      - custom_net
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy

  filter_transactions_by_hour_0:
    container_name: filter_transactions_by_hour_0
    image: filter_transactions_by_hour:latest
    entrypoint: python3 -m controllers.filters.filter_transactions_by_hour.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CONTROLLER_ID=0
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - PREV_CONTROLLERS_AMOUNT=3
      - FILTERS_AMOUNT=1
      - MIN_HOUR=6
      - MAX_HOUR=23
    networks:
      - custom_net
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy

  filter_transactions_by_hour_1:
    container_name: filter_transactions_by_hour_1
    image: filter_transactions_by_hour:latest
    entrypoint: python3 -m controllers.filters.filter_transactions_by_hour.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CONTROLLER_ID=1
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - PREV_CONTROLLERS_AMOUNT=3
      - FILTERS_AMOUNT=1
      - MIN_HOUR=6
      - MAX_HOUR=23
    networks:
      - custom_net
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy

  filter_transactions_by_final_amount_0:
    container_name: filter_transactions_by_final_amount_0
    image: filter_transactions_by_final_amount:latest
    entrypoint: python3 -m controllers.filters.filter_transactions_by_final_amount.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CONTROLLER_ID=0
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - PREV_CONTROLLERS_AMOUNT=2
      - OUTPUT_BUILDERS_AMOUNT=1
      - MIN_FINAL_AMOUNT=75.0
    networks:
      - custom_net
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy

  filter_items_by_year_0:
    container_name: filter_items_by_year_0
    image: filter_items_by_year:latest
    entrypoint: python3 -m controllers.filters.filter_items_by_year.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CONTROLLER_ID=0
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - PREV_CONTROLLERS_AMOUNT=4
      - MAPS_AMOUNT=3
      - YEARS=2024,2025
    networks:
      - custom_net
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy

  filter_items_by_year_1:
    container_name: filter_items_by_year_1
    image: filter_items_by_year:latest
    entrypoint: python3 -m controllers.filters.filter_items_by_year.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CONTROLLER_ID=1
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - PREV_CONTROLLERS_AMOUNT=4
      - MAPS_AMOUNT=3
      - YEARS=2024,2025
    networks:
      - custom_net
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy

  filter_items_by_year_2:
    container_name: filter_items_by_year_2
    image: filter_items_by_year:latest
    entrypoint: python3 -m controllers.filters.filter_items_by_year.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CONTROLLER_ID=2
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - PREV_CONTROLLERS_AMOUNT=4
      - MAPS_AMOUNT=3
      - YEARS=2024,2025
    networks:
      - custom_net
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy

  # ============================== MAP SERVICES ============================== #

  map_month_year_items_0:
    container_name: map_month_year_items_0
    image: map_month_year_items:latest
    entrypoint: python3 -m controllers.mappers.map_month_year_items.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CONTROLLER_ID=0
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - PREV_CONTROLLERS_AMOUNT=3
      - REDUCERS_AMOUNT=1
    networks:
      - custom_net
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy

  map_month_year_items_1:
    container_name: map_month_year_items_1
    image: map_month_year_items:latest
    entrypoint: python3 -m controllers.mappers.map_month_year_items.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CONTROLLER_ID=1
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - PREV_CONTROLLERS_AMOUNT=3
      - REDUCERS_AMOUNT=1
    networks:
      - custom_net
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy

  map_month_year_items_2:
    container_name: map_month_year_items_2
    image: map_month_year_items:latest
    entrypoint: python3 -m controllers.mappers.map_month_year_items.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CONTROLLER_ID=2
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - PREV_CONTROLLERS_AMOUNT=3
      - REDUCERS_AMOUNT=1
    networks:
      - custom_net
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy

  map_month_semester_transactions_0:
    container_name: map_month_semester_transactions_0
    image: map_month_semester_transactions:latest
    entrypoint: python3 -m controllers.mappers.map_month_semester_transactions.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CONTROLLER_ID=0
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - PREV_CONTROLLERS_AMOUNT=2
      - REDUCERS_AMOUNT=1
    networks:
      - custom_net
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy

  # ============================== REDUCERS SERVICES ============================== #

  count_purchases_by_store_id_and_user_id_0:
    container_name: count_purchases_by_store_id_and_user_id_0
    image: count_purchases_by_store_id_and_user_id:latest
    entrypoint: python3 -m controllers.reducers.count_purchases_by_store_id_and_user_id.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CONTROLLER_ID=0
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - PREV_CONTROLLERS_AMOUNT=3
      - BATCH_MAX_SIZE=${BATCH_MAX_SIZE}
    networks:
      - custom_net
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy

  count_transaction_items_0:
    container_name: count_transaction_items_0
    image: count_transaction_items:latest
    entrypoint: python3 -m controllers.reducers.count_transaction_items.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CONTROLLER_ID=0
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - PREV_CONTROLLERS_AMOUNT=3
      - BATCH_MAX_SIZE=${BATCH_MAX_SIZE}
    networks:
      - custom_net
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy

  sum_transaction_items_0:
    container_name: sum_transaction_items_0
    image: sum_transaction_items:latest
    entrypoint: python3 -m controllers.reducers.sum_transaction_items.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CONTROLLER_ID=0
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - PREV_CONTROLLERS_AMOUNT=3
      - BATCH_MAX_SIZE=${BATCH_MAX_SIZE}
    networks:
      - custom_net
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy

  sum_transactions_by_store_0:
    container_name: sum_transactions_by_store_0
    image: sum_transactions_by_store:latest
    entrypoint: python3 -m controllers.reducers.sum_transactions_by_store.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CONTROLLER_ID=0
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - PREV_CONTROLLERS_AMOUNT=1
      - BATCH_MAX_SIZE=${BATCH_MAX_SIZE}
      - JOINS_AMOUNT=1
    networks:
      - custom_net
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy

  # ============================== SORT TRANSACTIONS SERVICES ============================== #

  sort_desc_by_store_id_and_purchases_qty_0:
    container_name: sort_desc_by_store_id_and_purchases_qty_0
    image: sort_desc_by_store_id_and_purchases_qty:latest
    entrypoint: python3 -m controllers.sorters.sort_desc_by_store_id_and_purchases_qty.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CONTROLLER_ID=0
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - PREV_CONTROLLERS_AMOUNT=1
      - NEXT_CONTROLLERS_AMOUNT=2
      - BATCH_MAX_SIZE=${BATCH_MAX_SIZE}
      - AMOUNT_PER_GROUP=3
    networks:
      - custom_net
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy

  sort_desc_by_year_month_created_at_and_sellings_qty_0:
    container_name: sort_desc_by_year_month_created_at_and_sellings_qty_0
    image: sort_desc_by_year_month_created_at_and_sellings_qty:latest
    entrypoint: python3 -m controllers.sorters.sort_desc_by_year_month_created_at_and_sellings_qty.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CONTROLLER_ID=0
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - PREV_CONTROLLERS_AMOUNT=1
      - NEXT_CONTROLLERS_AMOUNT=1
      - BATCH_MAX_SIZE=${BATCH_MAX_SIZE}
      - AMOUNT_PER_GROUP=1
    networks:
      - custom_net
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy

  sort_desc_by_year_month_created_at_and_profit_sum_0:
    container_name: sort_desc_by_year_month_created_at_and_profit_sum_0
    image: sort_desc_by_year_month_created_at_and_profit_sum:latest
    entrypoint: python3 -m controllers.sorters.sort_desc_by_year_month_created_at_and_profit_sum.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CONTROLLER_ID=0
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - PREV_CONTROLLERS_AMOUNT=1
      - NEXT_CONTROLLERS_AMOUNT=1
      - BATCH_MAX_SIZE=${BATCH_MAX_SIZE}
      - AMOUNT_PER_GROUP=1
    networks:
      - custom_net
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy

  # ============================== JOIN SERVICES ============================== #

  join_transactions_with_users_0:
    container_name: join_transactions_with_users_0
    image: join_transactions_with_users:latest
    entrypoint: python3 -m controllers.joiners.join_transactions_with_users.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CONTROLLER_ID=0
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - PREV_BASE_DATA_CONTROLLERS_AMOUNT=1
      - PREV_STREAM_DATA_CONTROLLERS_AMOUNT=1
      - NEXT_CONTROLLERS_AMOUNT=2
    networks:
      - custom_net
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy

  join_transactions_with_users_1:
    container_name: join_transactions_with_users_1
    image: join_transactions_with_users:latest
    entrypoint: python3 -m controllers.joiners.join_transactions_with_users.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CONTROLLER_ID=1
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - PREV_BASE_DATA_CONTROLLERS_AMOUNT=1
      - PREV_STREAM_DATA_CONTROLLERS_AMOUNT=1
      - NEXT_CONTROLLERS_AMOUNT=2
    networks:
      - custom_net
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy

  join_transactions_with_stores_0:
    container_name: join_transactions_with_stores_0
    image: join_transactions_with_stores:latest
    entrypoint: python3 -m controllers.joiners.join_transactions_with_stores.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CONTROLLER_ID=0
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - PREV_BASE_DATA_CONTROLLERS_AMOUNT=1
      - PREV_STREAM_DATA_CONTROLLERS_AMOUNT=2
      - NEXT_CONTROLLERS_AMOUNT=1
    networks:
      - custom_net
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy

  join_transactions_with_stores_1:
    container_name: join_transactions_with_stores_1
    image: join_transactions_with_stores:latest
    entrypoint: python3 -m controllers.joiners.join_transactions_with_stores.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CONTROLLER_ID=1
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - PREV_BASE_DATA_CONTROLLERS_AMOUNT=1
      - PREV_STREAM_DATA_CONTROLLERS_AMOUNT=2
      - NEXT_CONTROLLERS_AMOUNT=1
    networks:
      - custom_net
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy

  join_item_count_with_menu_0:
    container_name: join_item_count_with_menu_0
    image: join_item_count_with_menu:latest
    entrypoint: python3 -m controllers.joiners.join_item_count_with_menu.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CONTROLLER_ID=0
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - OUTPUT_BUILDERS_AMOUNT=1
      - PREV_BASE_DATA_CONTROLLERS_AMOUNT=1
      - PREV_STREAM_DATA_CONTROLLERS_AMOUNT=1
      - NEXT_CONTROLLERS_AMOUNT=1
    networks:
      - custom_net
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy

  join_item_sum_with_menu_0:
    container_name: join_item_sum_with_menu_0
    image: join_item_sum_with_menu:latest
    entrypoint: python3 -m controllers.joiners.join_item_sum_with_menu.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CONTROLLER_ID=0
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - PREV_BASE_DATA_CONTROLLERS_AMOUNT=1
      - PREV_STREAM_DATA_CONTROLLERS_AMOUNT=1
      - NEXT_CONTROLLERS_AMOUNT=1
    networks:
      - custom_net
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy

  join_tpv_with_stores_0:
    container_name: join_tpv_with_stores_0
    image: join_tpv_with_stores:latest
    entrypoint: python3 -m controllers.joiners.join_tpv_with_stores.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CONTROLLER_ID=0
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - OUTPUT_BUILDERS_AMOUNT=1
      - PREV_BASE_DATA_CONTROLLERS_AMOUNT=1
      - PREV_STREAM_DATA_CONTROLLERS_AMOUNT=1
      - NEXT_CONTROLLERS_AMOUNT=1
    networks:
      - custom_net
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy

  # ============================== OUTPUT BUILDER SERVICES ============================== #

  query_1x_output_builder_0:
    container_name: query_1x_output_builder_0
    image: query_1x_output_builder:latest
    entrypoint: python3 -m controllers.output_builders.query_1x_output_builder.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CONTROLLER_ID=0
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - PREV_CONTROLLERS_AMOUNT=1
    networks:
      - custom_net
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy

  query_21_output_builder_0:
    container_name: query_21_output_builder_0
    image: query_21_output_builder:latest
    entrypoint: python3 -m controllers.output_builders.query_21_output_builder.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CONTROLLER_ID=0
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - PREV_CONTROLLERS_AMOUNT=1
    networks:
      - custom_net
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy

  query_22_output_builder_0:
    container_name: query_22_output_builder_0
    image: query_22_output_builder:latest
    entrypoint: python3 -m controllers.output_builders.query_22_output_builder.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CONTROLLER_ID=0
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - PREV_CONTROLLERS_AMOUNT=1
    networks:
      - custom_net
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy

  query_3x_output_builder_0:
    container_name: query_3x_output_builder_0
    image: query_3x_output_builder:latest
    entrypoint: python3 -m controllers.output_builders.query_3x_output_builder.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CONTROLLER_ID=0
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - PREV_CONTROLLERS_AMOUNT=1
    networks:
      - custom_net
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy

  query_4x_output_builder_0:
    container_name: query_4x_output_builder_0
    image: query_4x_output_builder:latest
    entrypoint: python3 -m controllers.output_builders.query_4x_output_builder.main
    environment:
      - PYTHONUNBUFFERED=${PYTHONUNBUFFERED}
      - LOGGING_LEVEL=${LOGGING_LEVEL}
      - CONTROLLER_ID=0
      - RABBITMQ_HOST=rabbitmq-message-middleware
      - PREV_CONTROLLERS_AMOUNT=2
    networks:
      - custom_net
    depends_on:
      rabbitmq-message-middleware:
        condition: service_healthy

networks:
  custom_net:
    ipam:
      driver: default
      config:
        - subnet: 172.25.125.0/24